#!/bin/bash
clear
shopt -s dotglob
echo "Initiating builds"
mountCmd="sudo /home/yogi/mount_chrisos"
unmountCmd="sudo /home/yogi/umount_chrisos"
#mountCmd2="sudo mount /dev/sdc6 /mnt/chrisos_hd"
#umountCmd2="sudo umount /mnt/chrisos_hd"
CLEAN=0
if [ "$1" != "" ]
then
	if [ "$1" == "clean" ]
	then
		echo Cleaning the room
		command="make clean "
		CLEAN=1
	else
		buildType=$1
		command="make -j8 CONF=$buildType build "
	fi
else
	buildType="Debug"
	command="make -j8 CONF=$buildType build "
fi

pathMid=dist/${buildType^}/GNU-Linux #GNU-Linux

declare -a kernProgArray=("chrisOS" "chrisOSKernel")
declare -a kernOutputArray=("chrisOS/$pathMid/chrisos" "chrisOSKernel/$pathMid/kernel")
declare -a appProgArray=("libChrisOS" "testMainProgramEntry" "kshell" "time" "testMMap" "sleep" "cat" "echo" "clock" "ls" "grep" "free" "top" "wc" "ps" "kill" "count")
declare -a appOutputArray=("libChrisOS/$pathMid/libc.so" "testMainProgramEntry/$pathMid/testmainprogramentry" "kshell/$pathMid/kshell" "time/$pathMid/time" "testMMap/$pathMid/testmmap" "sleep/$pathMid/sleep" "cat/$pathMid/cat" "echo/$pathMid/echo" "clock/$pathMid/clock" "ls/$pathMid/ls" "grep/$pathMid/grep" "free/$pathMid/free" "top/$pathMid/top" "wc/$pathMid/wc" "ps/$pathMid/ps" "kill/$pathMid/kill" "count/$pathMid/count")
basePath=../../../kproj/
tabs 5,36,50,70
echo "Build environment: ${buildType^}"
echo
echo "Making kernel projects"
for i in "${kernProgArray[@]}"
do
	pushd $basePath$i/ > /dev/null
	echo "  Make $i: ($buildType)"
	($command) > /dev/null
	if [ $? -eq 0 ] 
	then
		echo -en "\tMake $i ... \tsuccess!\n"
	else
		echo -en "\tMake $i ... \tfailed ($?)\n"
		echo 
		echo 
		($unmountCmd)
		tabs -8
		exit -1
	fi
	popd > /dev/null
done

echo "Making application projects"
basePath=../../../aproj/
for i in "${appProgArray[@]}"
do
	pushd $basePath/$i/ > /dev/null
	echo "  Make $i: ($buildType)"
	($command) > /dev/null
	if [ $? -eq 0 ] 
	then
		echo -en "\tMake $i ... \tsuccess!\n"
	else
		echo -en "\tMake $i ... \tfailed"
		echo 
		echo 
                ($unmountCmd)
		tabs -8
		exit -2
	fi
	popd > /dev/null
done

echo "Done making projects"
if [ "$CLEAN" == "1" ] 
then
	echo "Room's all clean!"
	exit 0
fi
echo "Copying output to disk and ISO directory"
($mountCmd)
#($mountCmd2)
basePath=/home/yogi/src/os/kproj

for i in "${kernOutputArray[@]}"
do
	sudo cp $basePath/$i /mnt/chrisos
	sudo cp $basePath/$i ~/src/os/build_dir/isodir/
#	sudo cp $basePath/$i /mnt/chrisos_hd
	echo -en "\t$i ...done\n"
done
basePath=/home/yogi/src/os/aproj
sudo mkdir /mnt/chrisos/bin
if [ ! -d "/mnt/loop/bin" ]; then
	sudo mkdir /mnt/loop/bin
#	sudo mkdir /mnt/chrisos_hd/bin
	echo bin directory created
else
	echo bin directory exists
fi
for i in "${appOutputArray[@]}"
do
	sudo cp $basePath/$i /mnt/chrisos/bin
	sudo cp $basePath/$i ~/src/os/build_dir/isodir/
#	sudo cp $basePath/$i /mnt/chrisos_hd/bin
	echo -en "\t$i ... done\n"
done
sudo cp $basePath/libChrisOS/$pathMid/libc.so /mnt/chrisos
#sudo cp $basePath/libChrisOS/$pathMid/libc.so /mnt/chrisos_hd
echo "Copying done"
echo "Builds complete"
tabs -8
echo "Copying extra stuff to disk"
cp Debug/GNU-Linux/chrisos ../../../build_dir/isodir/boot/myos.bin
rm ./myos.iso
grub-mkrescue -o myos.iso ../../../build_dir/isodir > /dev/null
($unmountCmd)
#($umountCmd2)
sync
